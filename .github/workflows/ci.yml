name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  version-check:
    name: Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check version consistency across packages
        run: |
          # Extract versions from all package files
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          NPM_VERSION=$(grep '"version"' mcp-server/package.json | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
          PYPI_VERSION=$(grep '^version = ' pyproject.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

          echo "Cargo.toml version: $CARGO_VERSION"
          echo "package.json version: $NPM_VERSION"
          echo "pyproject.toml version: $PYPI_VERSION"

          # Check all versions match
          if [ "$CARGO_VERSION" != "$NPM_VERSION" ] || [ "$CARGO_VERSION" != "$PYPI_VERSION" ]; then
            echo "::error::Version mismatch detected!"
            echo "  Cargo.toml:     $CARGO_VERSION"
            echo "  package.json:   $NPM_VERSION"
            echo "  pyproject.toml: $PYPI_VERSION"
            exit 1
          fi

          echo "✓ All versions match: $CARGO_VERSION"
          echo "### Version Check" >> $GITHUB_STEP_SUMMARY
          echo "All packages at version **$CARGO_VERSION**" >> $GITHUB_STEP_SUMMARY

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run Clippy
        run: |
          cargo clippy --all-targets -- -W clippy::all 2>&1 | tee clippy-output.txt
          WARNINGS=$(grep -c "warning:" clippy-output.txt || true)
          echo "### Clippy Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Passed |" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install LLVM (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-dev libclang-dev clang

      - name: Install LLVM (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm
          echo "LLVM_CONFIG_PATH=$(brew --prefix llvm)/bin/llvm-config" >> $GITHUB_ENV
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV

      - name: Build Release
        run: cargo build --release

      - name: Display build info (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          SIZE=$(ls -lh target/release/shodh-memory-server 2>/dev/null | awk '{print $5}' || echo "N/A")
          echo "### Build Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| shodh-memory-server | $SIZE |" >> $GITHUB_STEP_SUMMARY

      - name: Display build info (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $file = Get-Item target/release/shodh-memory-server.exe -ErrorAction SilentlyContinue
          $size = if ($file) { "{0:N2} MB" -f ($file.Length / 1MB) } else { "N/A" }
          "### Build Results (${{ matrix.os }})" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          "" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          "| Binary | Size |" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          "|--------|------|" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          "| shodh-memory-server.exe | $size |" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY

      - name: Upload binary (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: shodh-memory-linux
          path: target/release/shodh-memory-server
          if-no-files-found: ignore

      - name: Upload binary (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: shodh-memory-macos
          path: target/release/shodh-memory-server
          if-no-files-found: ignore

      - name: Upload binary (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: shodh-memory-windows
          path: target/release/shodh-memory-server.exe
          if-no-files-found: ignore

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Run all tests
        run: |
          cargo test --no-fail-fast 2>&1 | tee test-output.txt

      - name: Generate test summary
        if: always()
        run: |
          PASSED=$(grep -oP '\d+(?= passed)' test-output.txt | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' test-output.txt | tail -1 || echo "0")
          IGNORED=$(grep -oP '\d+(?= ignored)' test-output.txt | tail -1 || echo "0")

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| Ignored | $IGNORED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" != "0" ]; then
            echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A 5 "FAILED" test-output.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Run benchmarks
        run: |
          cargo bench --no-run 2>&1 || true
          # Run only relevance benchmarks (latency verification) to keep CI fast
          cargo bench --bench relevance_benchmarks -- latency_30ms_target 2>&1 | tee bench-output.txt || true

      - name: Parse and display benchmark results
        if: always()
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark | Time | Throughput |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------|------------|" >> $GITHUB_STEP_SUMMARY

          # Parse criterion output
          while IFS= read -r line; do
            if [[ "$line" =~ ^([a-zA-Z_/]+)[[:space:]]+time:[[:space:]]+\[([0-9.]+)[[:space:]]([a-zµ]+) ]]; then
              name="${BASH_REMATCH[1]}"
              time="${BASH_REMATCH[2]}"
              unit="${BASH_REMATCH[3]}"
              echo "| $name | $time $unit | - |" >> $GITHUB_STEP_SUMMARY
            fi
          done < bench-output.txt

          # If no benchmarks found, show raw output
          if ! grep -q "time:" bench-output.txt 2>/dev/null; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Raw Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 bench-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: target/criterion
          if-no-files-found: ignore

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [version-check, format, clippy, build, test, benchmark]
    if: always()
    steps:
      - name: Generate final summary
        run: |
          echo "# CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          version_icon="${{ needs.version-check.result == 'success' && '✅' || '❌' }}"
          format_icon="${{ needs.format.result == 'success' && '✅' || '❌' }}"
          clippy_icon="${{ needs.clippy.result == 'success' && '✅' || '❌' }}"
          build_icon="${{ needs.build.result == 'success' && '✅' || '❌' }}"
          test_icon="${{ needs.test.result == 'success' && '✅' || '❌' }}"
          bench_icon="${{ needs.benchmark.result == 'success' && '✅' || '⚠️' }}"

          echo "| Version | $version_icon ${{ needs.version-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format | $format_icon ${{ needs.format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy | $clippy_icon ${{ needs.clippy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | $build_icon ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | $test_icon ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmarks | $bench_icon ${{ needs.benchmark.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.version-check.result }}" == "success" && \
                "${{ needs.format.result }}" == "success" && \
                "${{ needs.clippy.result }}" == "success" && \
                "${{ needs.build.result }}" == "success" && \
                "${{ needs.test.result }}" == "success" ]]; then
            echo "### All critical checks passed" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### Some checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
